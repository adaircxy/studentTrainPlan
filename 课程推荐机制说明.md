# 课程推荐系统机制详解

## 📋 目录
1. [系统概述](#系统概述)
2. [推荐算法](#推荐算法)
3. [数据流程](#数据流程)
4. [推荐策略](#推荐策略)
5. [相似度计算](#相似度计算)
6. [动态更新机制](#动态更新机制)

---

## 🎯 系统概述

### 推荐系统架构

```
用户请求推荐
    ↓
Flask路由 (/getRecommedData)
    ↓
DynamicCourseRecommender (推荐器)
    ↓
├─ 课程推荐 (recommend_courses)
└─ 相似学生推荐 (recommend_similar_students)
    ↓
返回推荐结果 (JSON格式)
    ↓
前端ECharts图表展示
```

### 核心特点

1. **动态推荐**：每次调用都重新加载最新数据，确保推荐结果实时更新
2. **多策略融合**：协同过滤 + 冷启动 + 热门推荐
3. **专业选修优先**：只推荐"专业选修"类课程
4. **智能回退**：如果主算法失败，自动切换到备用算法

---

## 🧮 推荐算法

### 1. 基于用户的协同过滤（User-based Collaborative Filtering）

**适用场景**：学生选课历史充足（≥3门课程）

**算法流程**：

```
步骤1: 构建学生-课程评分矩阵
    - 行：学生
    - 列：课程
    - 值：综合评分（基于成绩和评价）

步骤2: 计算学生相似度
    - 使用皮尔逊相关系数
    - 找到与目标学生相似的其他学生

步骤3: 预测课程评分
    对于每门未选课程：
        预测评分 = Σ(相似度 × 相似学生对课程的评分) / Σ|相似度|
    
步骤4: 排序并推荐
    - 按预测评分降序排列
    - 取前N门课程推荐
```

**优点**：
- 推荐结果个性化
- 能发现学生的潜在兴趣
- 基于真实选课数据，推荐质量高

**缺点**：
- 需要足够的选课数据
- 计算复杂度较高

---

### 2. 冷启动推荐（Cold Start Recommendation）

**适用场景**：学生选课历史不足（<3门课程）

**推荐策略**：

```
步骤1: 获取学生专业信息

步骤2: 筛选专业选修课程
    - 只推荐"专业选修"类课程
    - 优先推荐学生专业下的课程

步骤3: 计算课程热度
    热度评分 = 选课人数 + 基础分(1.0)
    
    如果是专业课程：
        热度评分 += 10.0 (额外加分)

步骤4: 排序并推荐
    - 专业课程优先
    - 按热度降序排列
    - 取前N门课程推荐
```

**优点**：
- 解决新同学的推荐问题
- 基于专业匹配，推荐相关性强
- 即使没有选课数据也能推荐

**缺点**：
- 推荐结果不够个性化
- 主要依赖课程热度

---

### 3. 热门课程推荐（Popularity-based Recommendation）

**适用场景**：协同过滤失败时的回退策略

**推荐策略**：
- 统计每门课程的选课人数
- 按选课人数降序排列
- 推荐最热门的课程

---

## 📊 数据流程

### 数据加载流程

```
1. 查询所有学生信息
   SQL: SELECT STU_NO, NAME, MAJOR, AD_YEAR FROM STUDENT
   ↓
2. 查询所有课程信息
   SQL: SELECT CO_NO, CO_NAME, CLASSIFICATION, MAJOR FROM EDUCATION_PLAN
   ↓
3. 构建映射关系
   - 学生编号 → 矩阵ID
   - 课程编号 → 矩阵ID
   ↓
4. 初始化评分矩阵（全零矩阵）
   shape = (学生数, 课程数)
   ↓
5. 加载选课数据
   SQL: SELECT STU_NO, CO_NO, GRADE, COMMENT FROM CHOOSE
   ↓
6. 计算综合评分并填充矩阵
   评分 = f(成绩, 评价, 专业匹配度)
```

### 评分计算

**综合评分公式**：

```
评分 = 成绩因素 + 评价因素 + 默认评分

成绩因素（0-3分）：
    - 90分以上：3.0分
    - 80-89分：2.5分
    - 70-79分：2.0分
    - 60-69分：1.5分
    - 60分以下：1.0分

评价因素（0-2分）：
    - COMMENT字段（0-5分）→ 线性映射到0-2分
    - 公式：评价分 = COMMENT × 0.4

默认评分：
    - 如果成绩和评价都为0：2.0分（中等偏好）

最终评分范围：0-5分
```

---

## 🎲 推荐策略

### 策略选择流程

```
学生请求推荐
    ↓
检查选课数量
    ↓
┌─────────────────┬─────────────────┐
│ 选课数 < 3门     │ 选课数 ≥ 3门     │
│ (冷启动)        │ (数据充足)       │
│      ↓          │      ↓          │
│ 冷启动推荐       │ 协同过滤推荐     │
│      ↓          │      ↓          │
│ 基于专业+热度    │ 基于相似学生     │
└─────────────────┴─────────────────┘
    ↓
如果推荐失败 → 回退到热门课程推荐
```

### 课程筛选规则

1. **只推荐专业选修课程**
   - 课程类型以"专业选修"开头
   - 包括：专业选修、专业选修-计算机科学、专业选修-计算机工程等

2. **排除已选课程**
   - 从CHOOSE表中查询学生已选课程
   - 只推荐未选的课程

3. **专业匹配优先**
   - 优先推荐学生专业下的课程
   - 专业课程额外加分（+10分）

---

## 📐 相似度计算

### 1. 学生相似度（皮尔逊相关系数）

**公式**：
```
r = Σ((x-μx)(y-μy)) / sqrt(Σ(x-μx)² * Σ(y-μy)²)
```

**特点**：
- 范围：[-1, 1]
- 考虑评分基准的差异（不同学生评分习惯不同）
- 只考虑共同选过的课程
- 如果共同课程少于2门，相似度为0

**示例**：
```
学生A的评分向量：[3.5, 4.0, 2.0, 0, 0, 4.5, ...]
学生B的评分向量：[3.0, 4.5, 2.5, 0, 0, 4.0, ...]

共同选过的课程：课程1, 课程2, 课程3, 课程6
计算这4门课程的皮尔逊相关系数 → 相似度
```

---

### 2. 课程相似度（余弦相似度）

**公式**：
```
cos(θ) = (A·B) / (||A|| * ||B||)
```

**特点**：
- 范围：[-1, 1]
- 衡量选课模式的相似性
- 用于课程相似度计算（当前未使用）

---

## 🔄 动态更新机制

### 数据更新流程

```
学生选课/退课
    ↓
更新CHOOSE表
    ↓
下次请求推荐时：
    ↓
重新加载CHOOSE表数据
    ↓
重新构建评分矩阵
    ↓
重新计算推荐结果
    ↓
返回最新推荐
```

### 动态特性

1. **实时数据加载**
   - 每次调用 `get_recommendations()` 都会重新加载数据
   - 确保推荐结果基于最新的选课信息

2. **缓存机制**
   - 相似度计算结果会缓存
   - 但每次推荐都会清空缓存，确保使用最新数据

3. **前端刷新**
   - 提供"刷新推荐"按钮
   - 点击后重新获取最新推荐数据

---

## 📈 推荐结果展示

### 课程推荐图表

- **X轴**：喜爱程度（1-5分，归一化后）
- **Y轴**：课程名称
- **颜色映射**：根据评分高低显示不同颜色

### 相似学生推荐图表

- **X轴**：相似度（0-1，归一化后）
- **Y轴**：学生姓名
- **颜色映射**：根据相似度高低显示不同颜色

---

## 🔧 技术实现细节

### 数据归一化

**课程评分归一化**：
- 原始范围：0-5分
- 归一化到：1-5分
- 公式：`new_value = 1 + (5-1) * (value - min) / (max - min)`

**学生相似度归一化**：
- 原始范围：-1到1
- 归一化到：0-1
- 公式：`new_value = 0 + (1-0) * (value - min) / (max - min)`

### 异常处理

1. **数据为空**：返回空数据但保持格式
2. **学生不存在**：返回空列表
3. **协同过滤失败**：回退到冷启动推荐
4. **冷启动失败**：回退到热门课程推荐

---

## 💡 推荐系统优势

1. **个性化推荐**：基于学生选课历史，推荐相关课程
2. **动态更新**：选课后推荐结果自动更新
3. **多策略融合**：适应不同场景（新同学、老同学）
4. **专业匹配**：优先推荐专业相关课程
5. **智能回退**：确保总能返回推荐结果

---

## 🎓 使用建议

1. **新同学**：系统会自动使用冷启动推荐，基于专业推荐热门课程
2. **选课较多**：系统会使用协同过滤，推荐个性化课程
3. **选课后**：点击"刷新推荐"按钮，查看更新后的推荐结果
4. **推荐结果**：根据"喜爱程度"选择感兴趣的课程

---

## 📝 总结

课程推荐系统采用**基于用户的协同过滤算法**作为主要推荐策略，结合**冷启动推荐**和**热门推荐**作为补充，能够：

- ✅ 根据学生选课历史个性化推荐
- ✅ 处理新同学的冷启动问题
- ✅ 动态更新推荐结果
- ✅ 推荐专业相关的选修课程
- ✅ 推荐志同道合的朋友

整个系统设计灵活，能够适应不同的使用场景，确保学生总能获得有价值的课程推荐。

