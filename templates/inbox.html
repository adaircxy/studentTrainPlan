<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>æ¶ˆæ¯ä¸­å¿ƒ</title>
    <link href="{{ url_for('static', filename='css/style1.css') }}" rel="stylesheet" type="text/css" />
    <link rel="icon" href="{{ url_for('static', filename='images/logo.ico') }}" type="image/x-icon"/>
    <script src="{{ url_for('static', filename='js/jquery-2.2.4.min.js') }}" type="text/javascript"></script>
</head>

<body>
<div class="wapper_box">
    <div class="header_box"></div>
    <div class="header_box1">
        <div class="header_box2">
            <a class="logo_box" href="{{ url_for('index') }}">
                <img src="{{ url_for('static', filename='images/logo1.jpg') }}"/>
            </a>
            <ul class="nav_box">
                <li class="nav_1"><a class="nav_but" href="{{ url_for('personal_information') }}">ä¸ªäººä¸­å¿ƒ</a></li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('inbox') }}">æ¶ˆæ¯ä¸­å¿ƒ</a></li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('news_center') }}">è¯¾ç¨‹è®ºå›</a></li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('recommed') }}">è¯¾ç¨‹æ¨è</a></li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('course_selection') }}">é€‰è¯¾ä¸­å¿ƒ</a></li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('train_plan') }}">è¯¾ç¨‹è¿›åº¦</a></li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('index') }}">é¦–é¡µ</a></li>
            </ul>
        </div>
        <script>
            $(".nav_1").mouseenter(function(){
                $(this).find(".nav_slide").slideDown()
            });
            $(".nav_1").mouseleave(function(){
                $(".nav_slide").slideUp()
            });
        </script>
    </div>
</div>

<!-- æ¶ˆæ¯ä¸­å¿ƒä¸»ä½“ -->
<div class="inbox_container">
    <!-- é¡¶éƒ¨ç­›é€‰ä¸æœç´¢ -->
    <div class="toolbar">
        <div class="filters">
            <div class="filter_group">
                <label>åˆ†ç±»ï¼š</label>
                <select id="filter-category" class="filter_select">
                    <option value="">å…¨éƒ¨</option>
                    <option value="æ•™åŠ¡é€šçŸ¥">æ•™åŠ¡é€šçŸ¥</option>
                    <option value="é€‰è¯¾å…¬å‘Š">é€‰è¯¾å…¬å‘Š</option>
                    <option value="è€ƒè¯•å®‰æ’">è€ƒè¯•å®‰æ’</option>
                    <option value="ç³»ç»Ÿå…¬å‘Š">ç³»ç»Ÿå…¬å‘Š</option>
                </select>
            </div>
            <div class="filter_group">
                <label>æ’åºï¼š</label>
                <select id="filter-sort" class="filter_select">
                    <option value="desc">æœ€æ–°</option>
                    <option value="asc">æœ€æ—©</option>
                </select>
            </div>
        </div>
        <div class="search_box">
            <input type="text" id="search-keyword" class="search_input" placeholder="æœç´¢æ ‡é¢˜æˆ–å†…å®¹..." />
            <button class="search_btn" id="search-btn">ğŸ” æœç´¢</button>
        </div>
    </div>

    <!-- å…¬å‘Šåˆ—è¡¨ -->
    <div id="announcement-list" class="announcement_list">
        <div class="loading">åŠ è½½ä¸­...</div>
    </div>
</div>

<!-- æ¶ˆæ¯æç¤º -->
<div id="message" class="message_toast"></div>

<style>
.inbox_container {
    width: 1000px;
    margin: 30px auto;
    padding: 0 20px 40px 20px;
}

.toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    padding: 16px;
    margin-bottom: 20px;
}

.filters {
    display: flex;
    gap: 16px;
    align-items: center;
    flex-wrap: wrap;
}

.filter_group {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: #333;
}

.filter_select {
    padding: 8px 10px;
    border: 1px solid #d0d7de;
    border-radius: 4px;
    font-size: 13px;
    background: #fff;
    min-width: 120px;
}

.search_box {
    display: flex;
    gap: 10px;
    min-width: 320px;
}

.search_input {
    flex: 1;
    padding: 10px 12px;
    border: 1px solid #d0d7de;
    border-radius: 4px;
    font-size: 13px;
}

.search_btn {
    padding: 10px 16px;
    background: #003d79;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
}

.search_btn:hover { background: #0056b3; }

.announcement_list {
    display: flex;
    flex-direction: column;
    gap: 14px;
}

.announcement_card {
    border: 1px solid #f0f0f0;
    border-radius: 8px;
    padding: 14px 16px;
    background: #fff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    display: flex;
    justify-content: space-between;
    gap: 12px;
}

.card_left { flex: 1; }

.card_title_row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
}

.card_title {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: #333;
}

.tag {
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 12px;
    font-weight: 500;
}
.tag_info { background: #e6f7ff; color: #1890ff; }
.tag_warning { background: #fff7e6; color: #fa8c16; }
.tag_exam { background: #fff1f0; color: #f5222d; }
.tag_system { background: #f0f0f0; color: #666; }

.badge_pinned {
    padding: 2px 8px;
    background: #f5222d;
    color: #fff;
    border-radius: 10px;
    font-size: 12px;
    font-weight: 600;
}

.card_meta {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    color: #666;
    font-size: 12px;
    margin-bottom: 6px;
}

.card_desc {
    font-size: 13px;
    color: #555;
    line-height: 1.5;
}

.card_right {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 10px;
    min-width: 120px;
}

.read_status {
    font-size: 12px;
    color: #1890ff;
}
.read_status.read { color: #999; }

.btn_link {
    color: #003d79;
    text-decoration: none;
    font-size: 13px;
    padding: 6px 12px;
    border: 1px solid #003d79;
    border-radius: 4px;
    transition: all 0.2s;
}
.btn_link:hover {
    background: #003d79;
    color: #fff;
}

.loading, .error, .empty_state {
    text-align: center;
    padding: 40px 20px;
    color: #999;
    font-size: 14px;
}
.error { color: #f56c6c; }

.message_toast {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10001;
    min-width: 250px;
    display: none;
    font-size: 14px;
}
.message_toast.success { background: #52c41a; color: #fff; }
.message_toast.error { background: #f5222d; color: #fff; }

@media (max-width: 1080px) {
    .inbox_container { width: 95%; }
    .toolbar { flex-direction: column; gap: 12px; align-items: flex-start; }
    .search_box { width: 100%; }
}
</style>

<script>
$(function() {
    var readStoreKey = 'read_announcements';

    function getReadIds() {
        try {
            var data = localStorage.getItem(readStoreKey);
            return data ? JSON.parse(data) : [];
        } catch(e) { return []; }
    }

    function setReadId(id) {
        var ids = getReadIds();
        if (ids.indexOf(id) === -1) {
            ids.push(id);
            localStorage.setItem(readStoreKey, JSON.stringify(ids));
        }
    }

    function applyFilters() {
        $("#announcement-list").html('<div class="loading">åŠ è½½ä¸­...</div>');
        var category = $("#filter-category").val();
        var sort = $("#filter-sort").val();
        var keyword = $("#search-keyword").val().trim();

        $.ajax({
            url: "/api/announcements",
            type: "GET",
            data: {
                category: category,
                sort: sort,
                keyword: keyword
            },
            success: function(res) {
                if (res.success && res.data) {
                    renderAnnouncements(res.data);
                } else {
                    $("#announcement-list").html('<div class="error">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>');
                }
            },
            error: function() {
                $("#announcement-list").html('<div class="error">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>');
            }
        });
    }

    function renderAnnouncements(items) {
        if (!items || items.length === 0) {
            $("#announcement-list").html('<div class="empty_state">æš‚æ— å…¬å‘Š</div>');
            return;
        }
        var readIds = getReadIds();
        var html = '';
        items.forEach(function(item) {
            var tagClass = 'tag_info';
            if (item.category === 'é€‰è¯¾å…¬å‘Š') tagClass = 'tag_warning';
            else if (item.category === 'è€ƒè¯•å®‰æ’') tagClass = 'tag_exam';
            else if (item.category === 'ç³»ç»Ÿå…¬å‘Š') tagClass = 'tag_system';

            var isRead = readIds.indexOf(item.id) !== -1;
            var readClass = isRead ? 'read' : '';
            var pinned = item.pinned ? '<span class="badge_pinned">ç½®é¡¶</span>' : '';

            html += `
                <div class="announcement_card">
                    <div class="card_left">
                        <div class="card_title_row">
                            <h3 class="card_title">${item.title}</h3>
                            <span class="tag ${tagClass}">${item.category}</span>
                            ${pinned}
                        </div>
                        <div class="card_meta">
                            <span>å‘å¸ƒå•ä½ï¼š${item.publisher || 'æ•™åŠ¡å¤„'}</span>
                            <span>å‘å¸ƒæ—¶é—´ï¼š${item.time}</span>
                        </div>
                        <div class="card_desc">${(item.content || '').substring(0, 80)}...</div>
                    </div>
                    <div class="card_right">
                        <span class="read_status ${readClass}">${isRead ? 'å·²è¯»' : 'æœªè¯»'}</span>
                        <a class="btn_link" href="/announcement/${item.id}" target="_blank" onclick="markRead(${item.id})">æŸ¥çœ‹è¯¦æƒ…</a>
                    </div>
                </div>
            `;
        });
        $("#announcement-list").html(html);
    }

    window.markRead = function(id) {
        setReadId(id);
    }

    $("#search-btn").click(applyFilters);
    $("#search-keyword").keypress(function(e) {
        if (e.which === 13) applyFilters();
    });
    $("#filter-category, #filter-sort").change(applyFilters);

    applyFilters();
});
</script>

</body>
</html>