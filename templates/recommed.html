<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link href="{{ url_for('static', filename='css/style1.css') }}" rel="stylesheet" type="text/css" />
    <link rel="icon" href="{{ url_for('static', filename='images/logo.ico') }}" type="image/x-icon"/>
    <script src="{{ url_for('static', filename='js/jquery-2.2.4.min.js') }}" type="text/javascript"></script>
    <script src="{{ url_for('static', filename='js/echarts.min.js') }}" type="text/javascript"></script>
    <title>课程推荐</title>
</head>
<body>
<div class="wapper_box">
    <div class="header_box"></div>
    <div class="header_box1">
        <div class="header_box2">
            <a class="logo_box" href="{{ url_for('index') }}"><img src="{{ url_for('static', filename='images/logo1.jpg') }}"/></a>
            <ul class="nav_box">
                <li class="nav_1"><a class="nav_but" href="{{ url_for('personal_information') }}">个人中心</a></li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('inbox') }}">消息中心</a></li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('news_center') }}">课程论坛</a></li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('recommed') }}">课程推荐</a></li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('course_selection') }}">选课中心</a></li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('train_plan') }}">课程进度</a></li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('index') }}">首页</a></li>
            </ul>
        </div>
        <script>
            $(".nav_1").mouseenter(function(){ $(this).find(".nav_slide").slideDown() });
            $(".nav_1").mouseleave(function(){ $(".nav_slide").slideUp() });
        </script>
    </div>
</div>

<!-- 推荐主体 -->
<div class="recommend_container">
    <div class="page_header">
        <div>
            <h1 class="page_title">课程推荐</h1>
            <p class="page_subtitle">相似度分析 → 推荐结论 → 学习决策</p>
        </div>
        <div class="header_actions">
            <button class="btn_refresh" id="refresh-btn">刷新推荐</button>
            <span id="status-text" class="status_text">正在加载...</span>
        </div>
    </div>

    <!-- 顶部推荐依据可视化 -->
    <div class="analysis_section">
        <div class="analysis_card">
            <div class="card_header">
                <h2 class="card_title">课程相似度分析</h2>
            </div>
            <div id="course_chart" class="chart_box"></div>
            <div class="analysis_desc">
                基于已选课程、专业背景、学习方向等特征，计算待推荐课程与您的学习画像相似度。
            </div>
        </div>
        <div class="analysis_card">
            <div class="card_header">
                <h2 class="card_title">学习画像相似度</h2>
            </div>
            <div id="persona_chart" class="chart_box"></div>
            <div class="analysis_desc">
                综合课程选择、专业方向、兴趣标签，找到与您学习路径相近的匿名画像群体。
            </div>
        </div>
    </div>

    <!-- 课程推荐结果 -->
    <div class="results_section">
        <div class="section_header">
            <h2 class="section_title">推荐课程</h2>
            <a class="btn_link" href="{{ url_for('course_selection') }}">前往选课中心</a>
        </div>
        <div id="course-list" class="course_list_cards">
            <div class="loading">加载中...</div>
        </div>
    </div>

    <!-- 志同道合学习参考 -->
    <div class="persona_section">
        <div class="section_header">
            <h2 class="section_title">志同道合学习画像分析</h2>
        </div>
        <div id="persona-list" class="persona_list">
            <div class="loading">加载中...</div>
        </div>
    </div>
</div>

<!-- Toast -->
<div id="message" class="message_toast"></div>

<!-- 难度评分模态框 -->
<div id="difficulty-modal" class="modal_overlay">
    <div class="modal_content">
        <div class="modal_header">
            <h3 class="modal_title">课程难度评分</h3>
            <button class="modal_close" onclick="closeDifficultyModal()">&times;</button>
        </div>
        <div class="modal_body">
            <div class="course_info">
                <h4 id="rating-course-name">课程名称</h4>
                <p class="course_desc">请根据您对该课程的了解或学习经验，为课程难度进行评分</p>
            </div>
            
            <div class="rating_section">
                <div class="rating_item">
                    <label class="rating_label">整体难度：</label>
                    <div class="star_rating" data-rating="overall">
                        <span class="star" data-value="1">★</span>
                        <span class="star" data-value="2">★</span>
                        <span class="star" data-value="3">★</span>
                        <span class="star" data-value="4">★</span>
                        <span class="star" data-value="5">★</span>
                    </div>
                    <span class="rating_text" id="overall-text">请评分</span>
                </div>
                
                <div class="rating_item">
                    <label class="rating_label">理论难度：</label>
                    <div class="star_rating" data-rating="theory">
                        <span class="star" data-value="1">★</span>
                        <span class="star" data-value="2">★</span>
                        <span class="star" data-value="3">★</span>
                        <span class="star" data-value="4">★</span>
                        <span class="star" data-value="5">★</span>
                    </div>
                    <span class="rating_text" id="theory-text">请评分</span>
                </div>
                
                <div class="rating_item">
                    <label class="rating_label">实践难度：</label>
                    <div class="star_rating" data-rating="practice">
                        <span class="star" data-value="1">★</span>
                        <span class="star" data-value="2">★</span>
                        <span class="star" data-value="3">★</span>
                        <span class="star" data-value="4">★</span>
                        <span class="star" data-value="5">★</span>
                    </div>
                    <span class="rating_text" id="practice-text">请评分</span>
                </div>
                
                <div class="rating_item">
                    <label class="rating_label">作业难度：</label>
                    <div class="star_rating" data-rating="homework">
                        <span class="star" data-value="1">★</span>
                        <span class="star" data-value="2">★</span>
                        <span class="star" data-value="3">★</span>
                        <span class="star" data-value="4">★</span>
                        <span class="star" data-value="5">★</span>
                    </div>
                    <span class="rating_text" id="homework-text">请评分</span>
                </div>
            </div>
            
            <div class="comment_section">
                <label class="rating_label">评价说明：</label>
                <textarea id="difficulty-comment" placeholder="请简要说明您的评分理由或学习建议（可选）" rows="3"></textarea>
            </div>
            
            <div class="current_ratings">
                <h5>当前评分统计：</h5>
                <div id="rating-stats" class="rating_stats">
                    <div class="loading">加载中...</div>
                </div>
            </div>
        </div>
        <div class="modal_footer">
            <button class="btn_cancel" onclick="closeDifficultyModal()">取消</button>
            <button class="btn_submit" onclick="submitDifficultyRating()">提交评分</button>
        </div>
    </div>
</div>

<style>
.recommend_container { width: 1200px; margin: 30px auto; padding: 0 20px 40px 20px; }
.page_header { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }
.page_title { margin: 0; font-size: 24px; font-weight: 600; color: #003d79; }
.page_subtitle { margin: 0; font-size: 14px; color: #666; }
.header_actions { margin-left: auto; display: flex; align-items: center; gap: 10px; }
.btn_refresh { padding: 8px 14px; border: 1px solid #003d79; background: #003d79; color: #fff; border-radius: 4px; cursor: pointer; font-size: 13px; }
.btn_refresh:hover { background: #0056b3; }
.status_text { font-size: 13px; color: #999; }

.analysis_section { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 20px; }
.analysis_card { background: #fff; border: 1px solid #f0f0f0; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; }
.card_header { padding: 14px 16px; border-bottom: 1px solid #f0f0f0; }
.card_title { margin: 0; font-size: 16px; font-weight: 600; color: #333; }
.chart_box { width: 100%; height: 360px; }
.analysis_desc { padding: 10px 16px 14px 16px; font-size: 13px; color: #666; background: #f8f9fb; }

.results_section, .persona_section { background: #fff; border: 1px solid #f0f0f0; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 18px; margin-bottom: 18px; }
.section_header { display: flex; align-items: center; justify-content: space-between; padding-bottom: 10px; border-bottom: 2px solid #003d79; margin-bottom: 12px; }
.section_title { margin: 0; font-size: 18px; font-weight: 600; color: #333; }
.btn_link { color: #003d79; text-decoration: none; font-size: 13px; padding: 6px 12px; border: 1px solid #003d79; border-radius: 4px; transition: all 0.2s; }
.btn_link:hover { background: #003d79; color: #fff; }

.course_list_cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 12px; }
.course_card { border: 1px solid #f0f0f0; border-radius: 8px; padding: 14px; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 8px; }
.course_title_row { display: flex; justify-content: space-between; gap: 10px; align-items: center; }
.course_name { font-size: 15px; font-weight: 600; color: #333; }
.course_score { font-size: 14px; color: #003d79; font-weight: 600; }
.course_meta { font-size: 13px; color: #666; display: flex; gap: 12px; flex-wrap: wrap; }
.tag_list { display: flex; gap: 6px; flex-wrap: wrap; }
.tag { padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: 500; background: #e6f7ff; color: #1890ff; }
.tag_warn { background: #fff7e6; color: #fa8c16; }
.tag_match { background: #f6ffed; color: #52c41a; }
.card_actions { display: flex; gap: 10px; }
.btn_action { padding: 6px 12px; border: 1px solid #003d79; color: #003d79; background: #fff; border-radius: 4px; font-size: 13px; text-decoration: none; }
.btn_action:hover { background: #003d79; color: #fff; }

.persona_list { display: flex; flex-direction: column; gap: 10px; }
.persona_card { border: 1px solid #f0f0f0; border-radius: 8px; padding: 12px 14px; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.04); }
.persona_title { font-size: 14px; font-weight: 600; color: #333; margin-bottom: 6px; }
.persona_desc { font-size: 13px; color: #666; line-height: 1.5; }
.tag_dir { background: #f0f5ff; color: #2f54eb; }

.loading, .error, .empty_state { text-align: center; padding: 30px 10px; color: #999; font-size: 14px; }
.error { color: #f56c6c; }

.message_toast { position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10001; min-width: 240px; display: none; font-size: 14px; }
.message_toast.success { background: #52c41a; color: #fff; }
.message_toast.error { background: #f5222d; color: #fff; }

/* 难度评分模态框样式 */
.modal_overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; display: none; }
.modal_content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
.modal_header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid #f0f0f0; }
.modal_title { margin: 0; font-size: 18px; font-weight: 600; color: #333; }
.modal_close { background: none; border: none; font-size: 24px; color: #999; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; }
.modal_close:hover { color: #666; }
.modal_body { padding: 20px; }
.course_info { margin-bottom: 20px; }
.course_info h4 { margin: 0 0 8px 0; font-size: 16px; color: #003d79; }
.course_desc { margin: 0; font-size: 14px; color: #666; }

.rating_section { margin-bottom: 20px; }
.rating_item { display: flex; align-items: center; margin-bottom: 15px; gap: 12px; }
.rating_label { min-width: 80px; font-size: 14px; color: #333; font-weight: 500; }
.star_rating { display: flex; gap: 2px; }
.star { font-size: 20px; color: #ddd; cursor: pointer; transition: color 0.2s; user-select: none; }
.star:hover, .star.active { color: #ffa940; }
.star.hover { color: #ffa940; }
.rating_text { font-size: 13px; color: #666; min-width: 60px; }

.comment_section { margin-bottom: 20px; }
.comment_section textarea { width: 100%; border: 1px solid #d9d9d9; border-radius: 4px; padding: 8px 12px; font-size: 14px; resize: vertical; }
.comment_section textarea:focus { outline: none; border-color: #003d79; }

.current_ratings h5 { margin: 0 0 10px 0; font-size: 14px; color: #333; }
.rating_stats { font-size: 13px; color: #666; }
.stat_item { display: flex; justify-content: space-between; margin-bottom: 5px; }
.stat_bar { height: 8px; background: #f0f0f0; border-radius: 4px; overflow: hidden; margin: 2px 0; }
.stat_fill { height: 100%; background: #003d79; transition: width 0.3s; }

.modal_footer { display: flex; justify-content: flex-end; gap: 10px; padding: 16px 20px; border-top: 1px solid #f0f0f0; }
.btn_cancel, .btn_submit { padding: 8px 16px; border-radius: 4px; font-size: 14px; cursor: pointer; }
.btn_cancel { border: 1px solid #d9d9d9; background: #fff; color: #666; }
.btn_cancel:hover { background: #f5f5f5; }
.btn_submit { border: 1px solid #003d79; background: #003d79; color: #fff; }
.btn_submit:hover { background: #0056b3; }

@media (max-width: 1200px) {
    .recommend_container { width: 95%; }
    .analysis_section { grid-template-columns: 1fr; }
    .chart_box { height: 320px; }
}
</style>

<script>
$(function() {
    var courseChart = echarts.init(document.getElementById('course_chart'));
    var personaChart = echarts.init(document.getElementById('persona_chart'));

    function showToast(text, success) {
        var el = $("#message");
        el.text(text || '');
        el.removeClass("success error").addClass(success ? "success" : "error");
        el.fadeIn(200);
        setTimeout(function(){ el.fadeOut(200); }, 3000);
    }

    function setLoading() {
        $("#status-text").text("正在加载...");
        $("#course-list").html('<div class="loading">加载中...</div>');
        $("#persona-list").html('<div class="loading">加载中...</div>');
        var loadingOption = { title: { text: '加载中...', left: 'center', top: 'middle', textStyle: { color: '#666', fontSize: 14 } } };
        courseChart.setOption(loadingOption, true);
        personaChart.setOption(loadingOption, true);
    }

    function renderCharts(courseSource, personSource) {
        // 课程相似度图（柱状）
        courseChart.setOption({
            dataset: { source: courseSource },
            grid: { containLabel: true },
            xAxis: { name: '相似度' },
            yAxis: { type: 'category' },
            visualMap: {
                orient: 'horizontal',
                left: 'center',
                min: 1,
                max: 5,
                text: ['高', '低'],
                dimension: 0,
                inRange: { color: ['#D7DA8B', '#E15457'] }
            },
            series: [{ type: 'bar', encode: { x: 'amount', y: 'product' } }]
        }, true);

        // 画像相似度图（柱状）
        personaChart.setOption({
            dataset: { source: personSource },
            grid: { containLabel: true },
            xAxis: { name: '相似度' },
            yAxis: { type: 'category' },
            visualMap: {
                orient: 'horizontal',
                left: 'center',
                min: 0,
                max: 1,
                text: ['高', '低'],
                dimension: 0,
                inRange: { color: ['#D7DA8B', '#E15457'] }
            },
            series: [{ type: 'bar', encode: { x: 'amount', y: 'product' } }]
        }, true);
    }

    function renderCourseCards(courseSource) {
        // 数据格式：source: [["amount","product"], [score, name], ...]
        if (!courseSource || courseSource.length <= 1) {
            $("#course-list").html('<div class="empty_state">暂无课程推荐数据</div>');
            return;
        }
        var rows = courseSource.slice(1).map(function(r) {
            return { score: r[0], name: r[1] };
        });
        rows.sort(function(a,b){ return b.score - a.score; });
        var html = '';
        rows.slice(0, 6).forEach(function(item, idx) {
            var tags = ['学习路径相似', '专业方向匹配', '课程选择高度相似'];
            var tagHtml = tags.slice(0, 2 + (idx % 2)).map(function(t,i){
                var cls = i === 0 ? 'tag_match' : (i === 1 ? 'tag' : 'tag_warn');
                return '<span class="tag ' + cls + '">' + t + '</span>';
            }).join('');
            html += `
                <div class="course_card">
                    <div class="course_title_row">
                        <span class="course_name">${item.name || '推荐课程'}</span>
                        <span class="course_score">${(item.score || 0).toFixed(2)}</span>
                    </div>
                    <div class="course_meta">
                        <span>授课教师：待定</span>
                        <span>学分：待定</span>
                        <span>推荐依据：相似度分析</span>
                    </div>
                    <div class="tag_list">${tagHtml}</div>
                    <div class="card_actions">
                        <a class="btn_action" href="/course_selection">前往选课</a>
                        <a class="btn_action" href="/news_center" onclick="searchCourseInForum('${item.name}')">课程讨论</a>
                        <a class="btn_action" href="#" onclick="showDifficultyRating('${item.name}');return false;">难度评分</a>
                    </div>
                </div>
            `;
        });
        $("#course-list").html(html);
    }

    function renderPersonaList(personSource) {
        if (!personSource || personSource.length <= 1) {
            $("#persona-list").html('<div class="empty_state">暂无画像相似度数据</div>');
            return;
        }
        var rows = personSource.slice(1).map(function(r){ return { score: r[0], name: r[1] }; });
        rows.sort(function(a,b){ return b.score - a.score; });
        var cnt = rows.length;
        var topScore = rows[0].score || 0;
        var avgScore = rows.reduce(function(s,r){ return s + (r.score || 0); }, 0) / cnt;
        var tags = ['专业方向匹配','课程选择相近','学习节奏相似','兴趣方向一致','学习路径相似'];
        var coursesDir = ['算法与编程','系统基础','数据与智能','工程实践','软件工程'];
        var tagHtml = tags.slice(0,3).map(function(t){ return '<span class="tag tag_match">' + t + '</span>'; }).join('');
        var dirHtml = coursesDir.slice(0,3).map(function(t){ return '<span class="tag tag_dir">' + t + '</span>'; }).join('');

        $("#persona-list").html(`
            <div class="persona_card">
                <div class="persona_title">画像相似度摘要</div>
                <div class="persona_desc">
                    找到 <b>${cnt}</b> 份相似学习画像，最高相似度 <b>${(topScore*100).toFixed(1)}%</b>，平均相似度 <b>${(avgScore*100).toFixed(1)}%</b>。
                </div>
                <div class="persona_desc">主要相似特征：${tagHtml}</div>
                <div class="persona_desc">常见课程方向：${dirHtml}</div>
            </div>
        `);
    }

    function loadData() {
        setLoading();
        $.ajax({
            url: '/getRecommedData',
            type: 'GET',
            dataType: 'json',
            success: function(res) {
                if (!res) {
                    $("#status-text").text("加载失败");
                    showToast("推荐数据为空", false);
                    return;
                }
                var course = res.course && res.course.source ? res.course.source : [];
                var person = res.person && res.person.source ? res.person.source : [];
                renderCharts(course, person);
                renderCourseCards(course);
                renderPersonaList(person);
                $("#status-text").text("加载完成");
            },
            error: function(xhr) {
                $("#status-text").text("加载失败");
                showToast("加载推荐数据失败", false);
                var err = { title: { text: '加载失败', subtext: '请刷新重试', left: 'center', top: 'middle', textStyle: { color: '#f56c6c' } } };
                courseChart.setOption(err, true);
                personaChart.setOption(err, true);
                $("#course-list").html('<div class="error">加载失败，请刷新重试</div>');
                $("#persona-list").html('<div class="error">加载失败，请刷新重试</div>');
            }
        });
    }

    $("#refresh-btn").click(function(){ loadData(); });
    loadData();
});

// 难度评分相关功能
var currentRatings = { overall: 0, theory: 0, practice: 0, homework: 0 };
var currentCourseName = '';

function showDifficultyRating(courseName) {
    currentCourseName = courseName;
    $("#rating-course-name").text(courseName);
    
    // 重置评分
    currentRatings = { overall: 0, theory: 0, practice: 0, homework: 0 };
    $(".star").removeClass("active");
    $(".rating_text").text("请评分");
    $("#difficulty-comment").val("");
    
    // 加载当前课程的评分统计
    loadCourseRatingStats(courseName);
    
    $("#difficulty-modal").fadeIn(200);
}

function closeDifficultyModal() {
    $("#difficulty-modal").fadeOut(200);
}

function loadCourseRatingStats(courseName) {
    $("#rating-stats").html('<div class="loading">加载中...</div>');
    
    // 模拟加载评分统计数据
    setTimeout(function() {
        var mockStats = {
            overall: { avg: 3.2, count: 15, distribution: [1, 2, 6, 4, 2] },
            theory: { avg: 3.8, count: 15, distribution: [0, 1, 3, 8, 3] },
            practice: { avg: 2.9, count: 15, distribution: [2, 3, 5, 3, 2] },
            homework: { avg: 3.5, count: 15, distribution: [1, 1, 4, 6, 3] }
        };
        
        var labels = ['整体难度', '理论难度', '实践难度', '作业难度'];
        var keys = ['overall', 'theory', 'practice', 'homework'];
        var html = '';
        
        keys.forEach(function(key, idx) {
            var stat = mockStats[key];
            var stars = '';
            for (var i = 1; i <= 5; i++) {
                stars += '<span style="color: ' + (i <= Math.round(stat.avg) ? '#ffa940' : '#ddd') + '">★</span>';
            }
            html += '<div class="stat_item">';
            html += '<span>' + labels[idx] + '：</span>';
            html += '<span>' + stars + ' ' + stat.avg.toFixed(1) + ' (' + stat.count + '人评价)</span>';
            html += '</div>';
        });
        
        $("#rating-stats").html(html);
    }, 500);
}

function submitDifficultyRating() {
    // 检查是否至少有一个评分
    var hasRating = Object.values(currentRatings).some(function(r) { return r > 0; });
    if (!hasRating) {
        showToast("请至少为一个维度评分", false);
        return;
    }
    
    var comment = $("#difficulty-comment").val().trim();
    var data = {
        courseName: currentCourseName,
        ratings: currentRatings,
        comment: comment
    };
    
    // 模拟提交评分
    showToast("正在提交评分...", true);
    setTimeout(function() {
        showToast("评分提交成功，感谢您的反馈！", true);
        closeDifficultyModal();
    }, 1000);
}

// 星级评分交互
$(document).on('mouseenter', '.star', function() {
    var rating = $(this).closest('.star_rating').data('rating');
    var value = parseInt($(this).data('value'));
    var stars = $(this).closest('.star_rating').find('.star');
    
    stars.each(function(idx) {
        $(this).toggleClass('hover', idx < value);
    });
});

$(document).on('mouseleave', '.star_rating', function() {
    $(this).find('.star').removeClass('hover');
});

$(document).on('click', '.star', function() {
    var rating = $(this).closest('.star_rating').data('rating');
    var value = parseInt($(this).data('value'));
    var stars = $(this).closest('.star_rating').find('.star');
    
    currentRatings[rating] = value;
    
    stars.each(function(idx) {
        $(this).toggleClass('active', idx < value);
    });
    
    var texts = ['很简单', '较简单', '适中', '较困难', '很困难'];
    $("#" + rating + "-text").text(texts[value - 1] || '请评分');
});

// 点击模态框外部关闭
$(document).on('click', '.modal_overlay', function(e) {
    if (e.target === this) {
        closeDifficultyModal();
    }
});
</script>

</body>
</html>